#!/bin/bash
#
# ws_share is a helper script that can be used to grant quickly read access for
# a workspace to other users based on UNIX ACLs.
# See ws_share --help to get usage information.
#
# Known issues:
#   Changing file or directory permissions after sharing with the standard UNIX
#   commands chmod, etc. after sharing with another user will not modify the
#   rights appropriately for this user. However, you will likely get a message
#   from these tools, e.g.
#     chmod: ... new permissions are ....., not ....
#   A workaround to update permissions is to unshare and re-share the workspace
#   with the users.
#
# Copyright(c) 2021-2024 Christoph Niethammer <niethammer@hlrs.de>
#

progname=$(basename $0)

# Test for compatible getopt version.
# The parser needs an enhanced version of getopt.
# See man page of getopt for this test.
getopt --test
if [[ $? -ne 4 ]]; then
    echo "Error: $progname needs an enhaced getopt to work."
    exit 1
fi

function print_version() {
    echo "workspace version 1.5.0"
}

function usage() {
cat <<EOF
$progname allows to share an existing workspace with other users.

usage:

The following commands share / unshare a workspace (WS_NAME) with users:
 $progname share [-F FILESYSTEM] WS_NAME USER [USER...]
 $progname unshare [-F FILESYSTEM] WS_NAME USER [USER...]
 $progname unshare-all [-F FILESYSTEM] WS_NAME

Users that were granted read access to a workspace (WS_NAME) can be listed with
 $progname list WS_NAME

options:
   -F, --filesystem  ws filesystem
   -h, --help        show this help
       --version     show version information and exit

EOF
}


# parse command line, based on example provided by util-linux
OPTIONS=F:h
LONG_OPTIONS=filesystem:,help,version
PARSED=$(getopt --options=$OPTIONS --longoptions=$LONG_OPTIONS --name "$0" -- "$@")
if [[ $? -ne 0 ]]; then
    echo "Error: Command line error"
    usage
    exit 1
fi
eval set -- "$PARSED"
unset PARSED

# parse options
while true; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        -F|--filesystem)
            FILESYSTEM="$2"
            shift 2
            ;;
        --version)
            print_version
            exit 0
            ;;
        --)
            shift
            break
            ;;
        *)
            echo "Error: Found unknown option"
            usage
            exit 1
            ;;
    esac
done

ACTION="$1"
shift
WS_NAME="$1"
shift

if [[ -z "$ACTION" ]]; then
    echo "Error: no action specified"
    exit 1
fi
if [[ -z "$WS_NAME" ]]; then
    echo "Error: workspace name missing"
    exit 1
fi
WS_PATH=$(ws_find ${FILESYSTEM:+-F $FILESYSTEM} $WS_NAME)
if [[ $? -ne 0 || -z "$WS_PATH" ]]; then
    echo "Error: Invalid workspace name."
    exit 1
fi

get_mount_point() {
    local file_path="$1"
    df -P "$file_path" | awk 'NR==2 {print $6}'
}
# Determine which file system
MOUNTPOINT=$(get_mount_point "$WS_PATH")
# Determine if it's using nfs4
# equivalent to:  pcregrep -o1 " $MOUNTPOINT .*vers=(.)" /proc/mounts
NFS_VERS=$(grep " $MOUNTPOINT nfs.*vers=" /proc/mounts | sed -E 's/.*vers=(.).*/\1/')
USE_NFS4=0
if [ -n "$NFS_VERS" ] && [ "$NFS_VERS" -ge 4 ]; then
    USE_NFS4=1
fi

case $ACTION in
    list)
        getfacl -ap --omit-header "$WS_PATH" | grep user | cut -d : -f 2 | grep -v '^$'
        ;;
    share)
        USERS="$@"
        MACL=""
        NFS4_ACL=""
        for user in $USERS; do
            id "$user" >/dev/null 2>&1
            if [[ $? -ne 0 ]]; then
                echo "Error: User $user unknown"
                exit 1
            fi
            echo "Granting access for $user ..."
            MACL+="user:$user:rX,"
            MACL+="default:user:$user:rX,"
            SHARE_UID=$(id -ru "$user")
            NFS4_ACL+="A:d:$SHARE_UID:RWX,"
        done
        if [[ -z "$MACL" ]]; then
            # nothing to do
            exit 0
        fi

        # Test if the mechanism works only on the top level before recursing
        if [ "$USE_NFS4" == 1 ];  then
            nfs4_setfacl -R -a "$NFS4_ACL" "$WS_PATH"
        else
            setfacl -R -m "$MACL" "$WS_PATH"
        fi
        if [ "$?" -eq 0 ]; then
            echo "Success!"
        fi
        ;;
    unshare)
        USERS="$@"
        XACL=""
        for user in $USERS; do
            id "$user" >/dev/null 2>&1
            if [[ $? -ne 0 ]]; then
                echo "Error: User $user unknown"
                exit 1
            fi
            echo "Removing access for $user"
            XACL+="user:$user,"
            XACL+="default:user:$user,"
            SHARE_UIDS+="$(id -ru $user)@"
        done
        if [[ -z "$XACL" ]]; then
            # nothing to do
            exit 0
        fi
        if [ "$USE_NFS4" == 1 ];  then
            echo "Removing ACLs:"
            nfs4_getfacl -c "$WS_PATH"  |  grep -f <(echo "${SHARE_UIDS%%@}" | tr "@" "\n")
            nfs4_getfacl -c "$WS_PATH"  |  grep -f <(echo "${SHARE_UIDS%%@}" | tr "@" "\n") | nfs4_setfacl -R -X - "$WS_PATH"
        else
            setfacl -R -x "$XACL" "$WS_PATH"
        fi
        if [ "$?" -eq 0 ]; then
            echo "Success!"
        fi
        ;;
    unshare-all)
        if [ "$USE_NFS4" == 1 ];  then
            echo "Removing ACLs:"
            # Default rules don't have UID numbers
            nfs4_getfacl -c "$WS_PATH"  |  grep -wEe "[0-9]+"
            nfs4_getfacl -c "$WS_PATH"  |  grep -wEe "[0-9]+"  |  nfs4_setfacl -R -X - "$WS_PATH"
        else
            setfacl -R -b "$WS_PATH"
        fi
        if [ "$?" -eq 0 ]; then
            echo "Success!"
        fi
        ;;
    check)
        ;;
    *)
        echo "Error: Invalid action $ACTION"
        usage
        exit 1
esac
